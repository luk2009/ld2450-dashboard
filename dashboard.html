<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>LD2450 Dashboard</title>
  <script src="https://unpkg.com/mqtt@5/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 8px;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    h1 {
      color: #fff;
      font-size: 20px;
      text-align: center;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .card {
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px;
    }
    
    .status {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status.ok { background: #4caf50; }
    .status.err { background: #f44336; animation: none; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .status-text {
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      flex: 1;
      min-height: 0;
    }
    
    .radar-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    #canvas {
      border: 2px solid #667eea;
      border-radius: 8px;
      max-width: 100%;
      height: auto;
    }
    
    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .stat {
      text-align: center;
      padding: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      color: white;
    }
    
    .stat-label {
      font-size: 10px;
      opacity: 0.9;
      margin-bottom: 4px;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: bold;
    }
    
    .chart-container {
      flex: 1;
      position: relative;
      min-height: 0;
    }
    
    #chart {
      max-height: 100%;
    }
    
    /* Mobile (iPhone) */
    @media (max-width: 768px) {
      body { padding: 4px; }
      
      h1 { 
        font-size: 16px; 
        margin-bottom: 2px;
      }
      
      .container { gap: 4px; }
      
      .card { 
        padding: 6px;
        border-radius: 8px;
      }
      
      .main-content {
        grid-template-columns: 1fr;
        gap: 4px;
      }
      
      .stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
      }
      
      .stat {
        padding: 6px;
      }
      
      .stat-label { font-size: 9px; }
      .stat-value { font-size: 16px; }
      
      .status-bar { padding: 6px; }
      .status-text { font-size: 11px; }
      
      #canvas {
        width: 100%;
        max-width: 280px;
      }
    }
    
    /* Desktop */
    @media (min-width: 769px) {
      #canvas {
        width: 100%;
        max-width: 420px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ¯ LD2450 Dashboard</h1>
    
    <div class="card status-bar">
      <span class="status err" id="status"></span>
      <span class="status-text" id="statusText">Conectando MQTT...</span>
    </div>
    
    <div class="main-content">
      <div class="card radar-section">
        <canvas id="canvas" width="400" height="400"></canvas>
      </div>
      
      <div class="right-panel">
        <div class="card">
          <div class="stats">
            <div class="stat">
              <div class="stat-label">Presencia</div>
              <div class="stat-value" id="presence">-</div>
            </div>
            <div class="stat">
              <div class="stat-label">Targets</div>
              <div class="stat-value" id="count">-</div>
            </div>
            <div class="stat">
              <div class="stat-label">RSSI</div>
              <div class="stat-value" id="rssi">-</div>
            </div>
          </div>
        </div>
        
        <div class="card chart-container">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
// ===================== Config MQTT =====================
const MQTT_URL = 'wss://xf9e9780.ala.us-east-1.emqxsl.com:8084/mqtt';
const MQTT_USER = 'luk2009';
const MQTT_PASS = 'compu2005';
const DEVICE_ID = 'casa_sala_01';
const TOPIC = `ld2450/${DEVICE_ID}/telemetry`;

// ===================== Canvas radar =====================
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function drawGrid() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Grid lines
  ctx.strokeStyle = '#f0f0f0';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 6; i++) {
    const p = (i / 6) * canvas.width;
    ctx.beginPath(); 
    ctx.moveTo(p, 0); 
    ctx.lineTo(p, canvas.height); 
    ctx.stroke();
    ctx.beginPath(); 
    ctx.moveTo(0, p); 
    ctx.lineTo(canvas.width, p); 
    ctx.stroke();
  }
  
  // Center line
  ctx.strokeStyle = '#999';
  ctx.lineWidth = 2;
  ctx.beginPath(); 
  ctx.moveTo(canvas.width/2, 0); 
  ctx.lineTo(canvas.width/2, canvas.height); 
  ctx.stroke();
  
  // Base line (sensor position)
  ctx.strokeStyle = '#667eea';
  ctx.lineWidth = 3;
  ctx.beginPath(); 
  ctx.moveTo(0, canvas.height); 
  ctx.lineTo(canvas.width, canvas.height); 
  ctx.stroke();
}

function plotTarget(x, y, color) {
  const scaleX = canvas.width / 6;
  const scaleY = canvas.height / 6;
  const cx = canvas.width/2 + x * scaleX;
  const cy = canvas.height - y * scaleY;
  
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(cx, cy, 8, 0, Math.PI*2);
  ctx.fill();
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 2;
  ctx.stroke();
}

// ===================== Chart.js =====================
const chartCtx = document.getElementById('chart').getContext('2d');
const chart = new Chart(chartCtx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Distancia (m)',
      data: [],
      borderColor: '#667eea',
      backgroundColor: 'rgba(102, 126, 234, 0.1)',
      tension: 0.4,
      fill: true,
      pointRadius: 2,
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: { 
        beginAtZero: true, 
        max: 6,
        ticks: { font: { size: 10 } }
      },
      x: {
        ticks: { 
          font: { size: 9 },
          maxRotation: 0
        }
      }
    },
    plugins: {
      legend: { 
        display: true,
        labels: { font: { size: 11 } }
      }
    }
  }
});

// ===================== MQTT Client =====================
const client = mqtt.connect(MQTT_URL, {
  username: MQTT_USER,
  password: MQTT_PASS,
  clientId: 'web_' + Math.random().toString(16).slice(2, 10)
});

client.on('connect', () => {
  document.getElementById('status').className = 'status ok';
  document.getElementById('statusText').textContent = 'MQTT Conectado âœ“';
  client.subscribe(TOPIC);
});

client.on('message', (topic, payload) => {
  const data = JSON.parse(payload.toString());
  
  drawGrid();
  
  const colors = ['#e74c3c', '#3498db', '#2ecc71'];
  data.targets.forEach((t, i) => {
    if (t.valid) {
      plotTarget(t.x, t.y, colors[i]);
    }
  });
  
  document.getElementById('presence').textContent = data.presence ? 'SÃ­' : 'No';
  document.getElementById('count').textContent = data.count;
  document.getElementById('rssi').textContent = data.rssi;
  
  if (data.targets[0].valid) {
    const dist = Math.sqrt(data.targets[0].x**2 + data.targets[0].y**2).toFixed(2);
    const now = new Date().toLocaleTimeString('en-US', {hour12:false}).slice(0,5);
    
    chart.data.labels.push(now);
    chart.data.datasets[0].data.push(dist);
    
    if (chart.data.labels.length > 20) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update('none');
  }
});

client.on('error', (err) => {
  document.getElementById('status').className = 'status err';
  document.getElementById('statusText').textContent = 'Error: ' + err.message;
});

drawGrid();
</script>
</body>
</html>
